<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Equipamentos Públicos</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: Arial, sans-serif; }

    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 320px;
      height: 100%;
      background: white;
      padding: 15px;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    #map {
      margin-left: 320px;
      height: 100vh;
      width: calc(100% - 320px);
    }

    .point-input {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .point-input label {
      width: 30px;
      font-weight: bold;
      text-align: right;
    }
    .point-input input {
      width: 90px;
      padding: 4px;
      font-size: 13px;
    }

    button {
      width: 100%;
      padding: 8px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 12px 0;
      font-size: 14px;
    }
    button:hover { background: #45a049; }

    #results {
      margin-top: 15px;
    }
    .result-item {
      display: flex;
      align-items: center;
      padding: 6px 4px;
      margin-bottom: 6px;
      background: #f5f5f5;
      border-radius: 4px;
      border-left: 3px solid #4CAF50;
      font-size: 13px;
      cursor: pointer;
    }
    .result-item:hover {
      background: #e0e0e0;
    }
    .result-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .result-text b { display: block; color: #333; }
    .result-text span { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Lote (P1–P4)</h3>
    <div class="point-input">
      <label>P1:</label>
      <input type="text" id="lat1" value="-5.335614">
      <input type="text" id="lng1" value="-41.534703">
    </div>
    <div class="point-input">
      <label>P2:</label>
      <input type="text" id="lat2" value="-5.335989">
      <input type="text" id="lng2" value="-41.535198">
    </div>
    <div class="point-input">
      <label>P3:</label>
      <input type="text" id="lat3" value="-5.337221">
      <input type="text" id="lng3" value="-41.533836">
    </div>
    <div class="point-input">
      <label>P4:</label>
      <input type="text" id="lat4" value="-5.336337">
      <input type="text" id="lng4" value="-41.534902">
    </div>

    <div style="margin: 10px 0; font-size: 13px;">
      Raio (metros): 
      <input type="number" id="raio" value="3000" min="50" max="3000" style="width: 80px; padding: 3px;">
      <br><small style="color:#666;">Máx: 3000 m</small>
    </div>

    <button onclick="desenharLote()">Buscar Equipamentos Públicos</button>

    <div id="results"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const TIPO_PARA_NOME = {
      'hospital': 'Hospital',
      'clinic': 'Clínica Médica',
      'school': 'Escola',
      'university': 'Universidade',
      'college': 'Faculdade',
      'police': 'Delegacia de Polícia',
      'fire_station': 'Corpo de Bombeiros',
      'townhall': 'Prefeitura',
      'community_centre': 'Centro Comunitário',
      'library': 'Biblioteca',
      'theatre': 'Teatro',
      'cinema': 'Cinema',
      'social_facility': 'Instituição Social',
      'doctors': 'Consultório Médico',
      'pharmacy': 'Farmácia'
    };

    let map = null;
    let currentLayers = [];
    let equipamentosData = []; // Armazena dados dos equipamentos para clique

    function initMap() {
      map = L.map('map').setView([-5.3364, -41.5346], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
    }

    function calcularCentroide(coords) {
      const sumLat = coords.reduce((sum, p) => sum + p[0], 0);
      const sumLng = coords.reduce((sum, p) => sum + p[1], 0);
      return [sumLat / coords.length, sumLng / coords.length];
    }

    function ordenarPorAngulo(coords) {
      const centro = calcularCentroide(coords);
      return coords
        .map(p => ({ p, ang: Math.atan2(p[0] - centro[0], p[1] - centro[1]) }))
        .sort((a, b) => a.ang - b.ang)
        .map(x => x.p);
    }

    function distanciaHaversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function limparMapa() {
      currentLayers.forEach(layer => map.removeLayer(layer));
      currentLayers = [];
      document.getElementById('results').innerHTML = '';
      equipamentosData = [];
    }

    function formatarPopup(tags, dist) {
      let html = '<b>' + (tags.name || 'Sem nome') + '</b><br>';

      const tipo = TIPO_PARA_NOME[tags.amenity] || tags.amenity || 'Outro';
      html += '<b>Tipo:</b> ' + tipo + '<br>';
      html += '<b>Distância:</b> ' + dist + ' m<br>';

      // Dados adicionais em português
      if (tags.operator) html += '<b>Operador:</b> ' + tags.operator + '<br>';
      if (tags.phone || tags['contact:phone']) html += '<b>Telefone:</b> ' + (tags.phone || tags['contact:phone']) + '<br>';
      if (tags.email || tags['contact:email']) html += '<b>E-mail:</b> ' + (tags.email || tags['contact:email']) + '<br>';
      if (tags.website || tags.url) html += '<b>Site:</b> <a href="' + (tags.website || tags.url) + '" target="_blank">' + (tags.website || tags.url) + '</a><br>';
      if (tags.opening_hours) html += '<b>Horário de Funcionamento:</b> ' + tags.opening_hours + '<br>';

      // Montar endereço
      let endereco = '';
      if (tags['addr:housenumber']) endereco += tags['addr:housenumber'] + ', ';
      if (tags['addr:street']) endereco += tags['addr:street'] + ', ';
      if (tags['addr:city']) endereco += tags['addr:city'];
      if (tags['addr:postcode']) endereco += ' - CEP: ' + tags['addr:postcode'];

      if (endereco) html += '<b>Endereço:</b> ' + endereco.trim().replace(/,\s*$/, '') + '<br>';

      if (tags.wheelchair) html += '<b>Acessibilidade (cadeirante):</b> ' + (tags.wheelchair === 'yes' ? 'Sim' : 'Não') + '<br>';
      if (tags.fee) html += '<b>Taxa de Entrada:</b> ' + (tags.fee === 'yes' ? 'Sim' : 'Não') + '<br>';
      if (tags.description) html += '<b>Descrição:</b> ' + tags.description + '<br>';
      if (tags['ref:CNES']) html += '<b>Código CNES:</b> ' + tags['ref:CNES'] + '<br>';

      return html;
    }

    async function buscarEquipamentosPublicos(centro, raioMetros) {
      document.getElementById('results').innerHTML = '<p>Buscando equipamentos públicos...</p>';

      const [lat, lng] = centro;

      const overpassQuery = `
[out:json];
(
  node["amenity"~"hospital|clinic|school|university|college|police|fire_station|townhall|community_centre|library|theatre|cinema|social_facility|doctors|pharmacy"](around:${raioMetros},${lat},${lng});
  way["amenity"~"hospital|clinic|school|university|college|police|fire_station|townhall|community_centre|library|theatre|cinema|social_facility|doctors|pharmacy"](around:${raioMetros},${lat},${lng});
  relation["amenity"~"hospital|clinic|school|university|college|police|fire_station|townhall|community_centre|library|theatre|cinema|social_facility|doctors|pharmacy"](around:${raioMetros},${lat},${lng});
);
out center;
`;

      try {
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: overpassQuery,
          headers: { 'Content-Type': 'text/plain' }
        });

        if (!response.ok) throw new Error(`Erro ${response.status}`);

        const data = await response.json();

        const boundsPoints = [];
        const resultados = [];

        for (const el of data.elements) {
          const amenity = el.tags?.amenity || 'outro';
          let nome = el.tags?.name || TIPO_PARA_NOME[amenity] || 'Sem nome';
          let tipoExibicao = TIPO_PARA_NOME[amenity] || amenity;

          let lat = el.lat || el.center?.lat;
          let lng = el.lon || el.center?.lon;
          if (!lat || !lng) continue;

          const dist = Math.round(distanciaHaversine(centro[0], centro[1], lat, lng));
          if (dist > raioMetros) continue;

          let cor = '#FFA500';
          if (['hospital', 'clinic', 'doctors', 'pharmacy'].includes(amenity)) cor = '#FF0000';
          else if (['school', 'university', 'college'].includes(amenity)) cor = '#0000FF';
          else if (['police', 'fire_station'].includes(amenity)) cor = '#000000';

          // Linha do centro do lote até o equipamento
          const linha = L.polyline([centro, [lat, lng]], {
            color: cor,
            weight: 1.5,
            opacity: 0.6
          }).addTo(map);
          currentLayers.push(linha);

          const popupContent = formatarPopup(el.tags, dist);

          const marker = L.circleMarker([lat, lng], {
            radius: 6,
            color: cor,
            fillColor: cor,
            fillOpacity: 0.8
          }).addTo(map)
            .bindPopup(popupContent);

          currentLayers.push(marker);
          boundsPoints.push([lat, lng]);
          resultados.push({ nome, tipo: tipoExibicao, dist, lat, lng, cor, tags: el.tags, marker });
        }

        // Ajusta zoom para mostrar tudo
        const polygon = currentLayers.find(layer => layer instanceof L.Polygon);
        if (polygon) {
          const bounds = polygon.getBounds();
          boundsPoints.forEach(p => bounds.extend(p));
          map.fitBounds(bounds.pad(0.1));
        } else if (boundsPoints.length > 0) {
          map.fitBounds(L.latLngBounds(boundsPoints).pad(0.1));
        }

        // ✅ ORDENAR ANTES DE ARMAZENAR EM equipamentosData
        resultados.sort((a, b) => a.dist - b.dist);
        equipamentosData = [...resultados]; // Agora está ordenado

        // Exibe resultados no sidebar com bolinhas coloridas
        const resultsDiv = document.getElementById('results');
        if (resultados.length === 0) {
          resultsDiv.innerHTML = `<p>Nenhum equipamento público encontrado dentro de ${raioMetros} m.</p>`;
        } else {
          resultsDiv.innerHTML = resultados.map((r, idx) => `
            <div class="result-item" onclick="centralizarEquipamento(${idx})">
              <div class="result-dot" style="background-color: ${r.cor};"></div>
              <div class="result-text">
                <b>${r.nome}</b>
                <span>${r.tipo} • ${r.dist} m</span>
              </div>
            </div>
          `).join('');
        }

      } catch (err) {
        console.error(err);
        document.getElementById('results').innerHTML = 
          '<p style="color:red;">Erro ao buscar dados.<br>Tente com raio ≤ 2000m.</p>';
      }
    }

    function centralizarEquipamento(index) {
      const equip = equipamentosData[index];
      if (equip && equip.marker) {
        map.setView([equip.lat, equip.lng], 17); // Zoom mais próximo
        equip.marker.openPopup();
      }
    }

    function desenharLote() {
      limparMapa();

      const inputs = [
        { lat: document.getElementById('lat1').value, lng: document.getElementById('lng1').value },
        { lat: document.getElementById('lat2').value, lng: document.getElementById('lng2').value },
        { lat: document.getElementById('lat3').value, lng: document.getElementById('lng3').value },
        { lat: document.getElementById('lat4').value, lng: document.getElementById('lng4').value }
      ];

      const coords = [];
      for (let i = 0; i < inputs.length; i++) {
        const lat = parseFloat(inputs[i].lat.replace(',', '.'));
        const lng = parseFloat(inputs[i].lng.replace(',', '.'));
        if (isNaN(lat) || isNaN(lng)) {
          alert(`Ponto ${i + 1}: valor inválido.`);
          return;
        }
        coords.push([lat, lng]);
      }

      const coordsOrdenadas = ordenarPorAngulo(coords);
      const centro = calcularCentroide(coordsOrdenadas);

      const polygon = L.polygon(coordsOrdenadas, {
        color: '#FF0000',
        weight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.15
      }).addTo(map);
      currentLayers.push(polygon);

      const raio = parseInt(document.getElementById('raio').value) || 3000;
      if (raio < 50) {
        alert('Raio mínimo: 50 metros.');
        return;
      }

      buscarEquipamentosPublicos(centro, raio);
    }

    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>